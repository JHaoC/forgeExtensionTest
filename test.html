<!DOCTYPE html>
<html>
    <head>
        <title>DataViz HTML Example - Stadium</title>
        <link
            rel="stylesheet"
            href="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/style.min.css"
            type="text/css"
        />
        <meta
            name="viewport"
            content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=no"
        />
        <meta charset="utf-8" />

        <style>
            #forgeViewer {
                width: 100%;
                height: 100%;
            }
        </style>

        <script src="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/viewer3D.min.js"></script>
        <script src="https://6jm6lvl74k.execute-api.us-west-2.amazonaws.com/latest/_adsk.js"></script>

        <script>
            let urn =
                "urn:dXJuOmFkc2sud2lwcHJvZDpmcy5maWxlOnZmLlN2Mkg4aUFuUXZxems2R1hnbHM1VEE_dmVyc2lvbj0y";
            let viewer;

            function initPage() {
                var av = Autodesk.Viewing;

                var options = {
                    env: "AutodeskProduction",
                    api: "derivativeV2", // for models uploaded to EMEA change this option to 'derivativeV2_EU'
                    accessToken: "eyJhbGciOiJSUzI1NiIsImtpZCI6IlU3c0dGRldUTzlBekNhSzBqZURRM2dQZXBURVdWN2VhIn0.eyJzY29wZSI6WyJ1c2VyLXByb2ZpbGU6cmVhZCIsImRhdGE6cmVhZCIsImFjY291bnQ6cmVhZCJdLCJjbGllbnRfaWQiOiIybEs0V09OallzQWRKR3pGeEp1bzliQUhIVldud0M0MiIsImF1ZCI6Imh0dHBzOi8vYXV0b2Rlc2suY29tL2F1ZC9hand0ZXhwNjAiLCJqdGkiOiI0Z0ZWNlRvcVBnUUQ3WEZ1SUp0eUdCcnhGWGNwbE13Z3F2VFBqOVQyMGZYTnNvT2tlcWZ0aGZNYzVidlFUWlIxIiwidXNlcmlkIjoiWk5aSk5GTjJSTkFUIiwiZXhwIjoxNjQ0MzQxNTgzfQ.PdycCEZzBjNDbfyix3XD7StIhLp7xyZlYAJk1TmV3YdBDrYuy1_Flq74qREMj52U7C0ShS32bj54TM4ewvFCB2RiBkQa-CWIc7_tgQ4K8QsmGedG70JaUOfHr6kNddukKGvC4ryh8h3BCwL-rv-iMXbc83UzO5uFdYiO0n6ilDiU3P1qPuNpPtEFg0dGLWdTXbp2rxHY1_bQWn8S22DTLXxMBYuZ5Og-4cIEJKFINMlK9xpuf55MUaTPt6GPvmsgrhtZkHKO-czUZkFqjiQzs-sf2K9macoEdSyCxdR6mjzR-3X4itmH4ZuYcHk-gRZd2nHHMI-f3YwABqg8bob6VQ",
                };

                Autodesk.Viewing.Initializer(options, function () {
                    var htmlDiv = document.getElementById("forgeViewer");
                    viewer = new Autodesk.Viewing.GuiViewer3D(htmlDiv);

                    const startedCode = viewer.start(
                        undefined,
                        undefined,
                        undefined,
                        undefined,
                        options
                    );
                    if (startedCode > 0) {
                        console.error("Failed to create a Viewer: WebGL not supported.");
                        return;
                    }

                    console.log("Initialization complete, loading a model next...");
                    viewer.addEventListener(av.GEOMETRY_LOADED_EVENT, onModelLoaded, {
                        once: true,
                    });
                    loadModel(viewer, urn);
                });

                function loadModel(viewer, documentId) {
                    Autodesk.Viewing.Document.load(
                        urn,
                        onDocumentLoadSuccess,
                        onDocumentLoadFailure
                    );

                    function onDocumentLoadSuccess(viewerDocument) {
                        var defaultModel = viewerDocument.getRoot().getDefaultGeometry(true);
                        viewer.loadDocumentNode(viewerDocument, defaultModel);
                    }

                    function onDocumentLoadFailure() {
                        console.error("Failed fetching Forge manifest");
                    }
                }
            }

            async function onModelLoaded() {
                // Load 'Autodesk.DataVisualization' and store it as a variable for later use
                const dataVizExtn = await viewer.loadExtension("Autodesk.DataVisualization");

                const DataVizCore = Autodesk.DataVisualization.Core;
                const viewableType = DataVizCore.ViewableType.SPRITE;
                const spriteColor = new THREE.Color(0xffffff);
                const baseURL = "https://shrikedoc.github.io/data-visualization-doc/_static/";
                const spriteIconUrl = `${baseURL}fan-00.svg`;

                const style = new DataVizCore.ViewableStyle(
                    viewableType,
                    spriteColor,
                    spriteIconUrl
                );

                const viewableData = new DataVizCore.ViewableData();
                viewableData.spriteSize = 24; // Sprites as points of size 24 x 24 pixels

                const myDataList = [
                    { position: { x: 10, y: 2, z: 3 } },
                    { position: { x: 20, y: 22, z: 3 } },
                ];

                myDataList.forEach((myData, index) => {
                    const dbId = 10 + index;
                    const position = myData.position;
                    const viewable = new DataVizCore.SpriteViewable(position, style, dbId);

                    viewableData.addViewable(viewable);
                });

                await viewableData.finish();
                dataVizExtn.addViewables(viewableData);

                // function startCameraTransition() {
                //     viewer.hide(20524); // Hide Roof Panels
                //     viewer.autocam.shotParams.destinationPercent = 3; // slow down camera movement
                //     viewer.autocam.shotParams.duration = 10;
                //     // move camera to hero view
                //     viewer.setViewFromArray([
                //         1.5082,
                //         -30.912,
                //         88.6316,
                //         -13.5,
                //         -1.87081,
                //         21.0,
                //         0,
                //         0,
                //         1,
                //         1.865,
                //         1.22,
                //         1,
                //         0,
                //     ]);
                // }
                // startCameraTransition(viewer);
            }
        </script>
    </head>

    <body onload="initPage()" style="margin:0;height:100vh;">
        <div id="forgeViewer"></div>
    </body>
</html>